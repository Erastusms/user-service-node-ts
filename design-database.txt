-- Ekstensi ini wajib untuk menggunakan UUID sebagai primary key
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Kita gunakan ENUM untuk data yang pilihannya terbatas, ini lebih hemat
CREATE TYPE user_status AS ENUM (
  'ACTIVE',     -- Pengguna normal dan aktif
  'PENDING',    -- Menunggu verifikasi (jika diperlukan)
  'SUSPENDED',  -- Diblokir sementara oleh admin
  'DEACTIVATED' -- Dihapus/dinonaktifkan oleh pengguna
);

-- Ini adalah tabel inti untuk User-Service
CREATE TABLE users (
  -- 'id' adalah UUID. Ini adalah kunci penghubung ke semua service lain.
  -- Auth-Service akan menyimpan 'id' ini sebagai referensi.
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- Nama publik yang akan ditampilkan
  display_name VARCHAR(100) NOT NULL,

  -- Nama legal/pribadi, bisa jadi opsional
  first_name VARCHAR(100),
  last_name VARCHAR(100),

  -- Data profil
  profile_image_url TEXT,
  bio TEXT,

  -- ENUM status yang sudah kita definisikan
  status user_status NOT NULL DEFAULT 'PENDING',

  -- JSONB sangat powerfull untuk data semi-terstruktur
  -- Misal: preferensi tema, bahasa, notifikasi, dll.
  metadata JSONB DEFAULT '{}',

  -- Timestamp standar
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Buat index pada display_name jika Anda berencana sering mencari berdasarkan nama
CREATE INDEX idx_users_display_name ON users(display_name);

-- Trigger untuk otomatis memperbarui updated_at setiap kali ada perubahan
CREATE OR REPLACE FUNCTION trigger_set_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_timestamp
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE PROCEDURE trigger_set_timestamp();